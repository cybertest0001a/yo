import requests
import os
import time

def download_file(url, local_filename, max_retries=3, chunk_size=8192):
    partial_size = os.path.getsize(local_filename) if os.path.exists(local_filename) else 0
    headers = {'Range': f'bytes={partial_size}-'} if partial_size > 0 else {}
    mode = 'ab' if partial_size > 0 else 'wb'
    
    for attempt in range(max_retries + 1):
        try:
            print(f"Attempt {attempt + 1}/{max_retries + 1}" + (f" (resuming from {partial_size} bytes)" if partial_size else ""))
            with requests.get(url, headers=headers, stream=True, timeout=(30, None)) as r:
                r.raise_for_status()
                total_size = int(r.headers.get('content-length', 0)) + partial_size if partial_size > 0 else int(r.headers.get('content-length', 0))
                
                with open(local_filename, mode) as f:
                    iterable = r.iter_content(chunk_size=chunk_size)
                    try:
                        from tqdm import tqdm
                        iterable = tqdm(iterable, total=total_size, unit='B', unit_scale=True, initial=partial_size)
                    except ImportError:
                        pass
                    
                    for chunk in iterable:
                        if chunk:
                            f.write(chunk)
                
                final_size = os.path.getsize(local_filename)
                if total_size == 0 or final_size >= total_size:
                    print(f"Downloaded '{local_filename}' successfully ({final_size} bytes)")
                    return
                else:
                    raise requests.exceptions.RequestException("Incomplete")
                    
        except (requests.exceptions.RequestException, OSError) as e:
            print(f"Attempt {attempt + 1} failed: {e}")
            if attempt == max_retries:
                print(f"Failed after {max_retries} retries. Partial file: {final_size if 'final_size' in locals() else partial_size} bytes")
                return
            partial_size = os.path.getsize(local_filename)  # Update for next resume
            time.sleep(2 ** attempt)

# Usage
file_url = "https://github.com/PowerShell/PowerShell/releases/download/v7.5.4/PowerShell-7.5.4-win-x64.zip"
output_filename = "PowerShell-7.5.4-win-x64.zip"
download_file(file_url, output_filename)
